<!--
Author: Adam ChapChap Ng'uni
Last Updated: 2025-08-09 21:55 CAT
File: templates/creating_db.html
Purpose: Progress screen with Savanna theme & logo; calls /api/create-db and redirects on success.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Creating {{ db_name }}…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- No-cache headers to avoid stale states -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root { --form-width: 720px; --radius: 10px; --glow: rgba(0,170,255,.42); }
    * { box-sizing: border-box; }
    body {
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:#000; color:#0af; font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
    }
    .card {
      width:min(100%, var(--form-width));
      background:#111; padding:30px; border-radius:14px; text-align:center;
      box-shadow:0 0 22px var(--glow);
    }
    .logo { display:block; margin:0 auto 10px; width:120px; height:auto; filter: drop-shadow(0 0 6px var(--glow)); }
    .pill { display:inline-block; padding:4px 10px; border-radius:9999px; background:#0af; color:#000; font-weight:800; margin-bottom:10px; }
    h3 { margin:8px 0 18px; color:#0af; }
    .spinner {
      width:56px; height:56px; border-radius:50%;
      border:5px solid #0af; border-top-color:transparent; margin:18px auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .alert { display:none; margin-top:16px; padding:12px; border-radius: var(--radius); background:#2a0f0f; color:#ffb3b3; }
    .btn { display:none; margin:12px auto 0; padding:10px 16px; background:#0af; color:#000; border:0; border-radius: var(--radius); font-weight:800; cursor:pointer; }
    .btn:hover { background:#08c; }
  </style>
</head>
<body>
  <div class="card">
    <img src="/static/savannalogo.png" alt="Savanna Solutions" class="logo" />
    <span class="pill">Edition: {{ edition }}</span>
    <h3>Creating database <code>{{ db_name }}</code></h3>

    <div class="spinner" aria-hidden="true"></div>
    <p class="hint" style="color:#9bd">This usually takes 10–60 seconds. Don’t close this tab.</p>

    <div id="err" class="alert"></div>
    <button id="retryBtn" class="btn">Try Again</button>
  </div>

  <script>
    // Author: Adam ChapChap Ng'uni | Last Updated: 2025-08-09 21:55 CAT
    // Server-provided payload (nonce included)
    const payload = {{ payload | tojson | safe }};

    async function createDb() {
      const err = document.getElementById('err');
      const retry = document.getElementById('retryBtn');
      err.style.display = 'none'; err.textContent = '';
      retry.style.display = 'none';

      try {
        const r = await fetch('/api/create-db', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
          cache: 'no-store',
        });
        const j = await r.json().catch(() => ({}));
        if (j.ok && j.redirect) { window.location.assign(j.redirect); return; }
        err.textContent = j.error || 'Unknown error while creating the database.';
        err.style.display = 'block'; retry.style.display = 'inline-block';
      } catch (e) {
        err.textContent = 'Network error talking to the backend. Please try again.';
        err.style.display = 'block'; retry.style.display = 'inline-block';
      }
    }

    document.getElementById('retryBtn').addEventListener('click', () => window.location.reload());
    createDb();
  </script>
</body>
</html>

